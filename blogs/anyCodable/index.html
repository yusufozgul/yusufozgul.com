<!DOCTYPE html><html lang="tr"><head><meta charset="UTF-8"/><meta property="og:site_name" content="Yusuf Özgül | Blog | Resume | Portfolio"/><link rel="canonical" href="https://yusufozgul.com/blogs/anyCodable"/><meta name="twitter:url" content="https://yusufozgul.com/blogs/anyCodable"/><meta property="og:url" content="https://yusufozgul.com/blogs/anyCodable"/><title>Any Codable | Yusuf Özgül | Blog | Resume | Portfolio</title><meta name="twitter:title" content="Any Codable | Yusuf Özgül | Blog | Resume | Portfolio"/><meta property="og:title" content="Any Codable | Yusuf Özgül | Blog | Resume | Portfolio"/><meta name="description" content="Any tipini decode veya encode etmemiz gerekirse nasıl yaparız?"/><meta name="twitter:description" content="Any tipini decode veya encode etmemiz gerekirse nasıl yaparız?"/><meta property="og:description" content="Any tipini decode veya encode etmemiz gerekirse nasıl yaparız?"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><link rel="stylesheet" href="/gallery.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/upload-images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Yusuf Özgül | Blog | Resume | Portfolio"/><meta name="twitter:image" content="https://yusufozgul.com/upload-images/"/><meta property="og:image" content="https://yusufozgul.com/upload-images/"/></head><body class="main-wrapper"><header><link rel="stylesheet" href="/navigationStyle.css" type="text/css"/><nav class="header navBar"><div class="navArea"><input type="checkbox" id="check"/><label for="check"><img src="/upload-images/base/menu-icon.svg" width="30" height="30" class="checkbtn"/></label><label class="logo"><a href="/">Yusuf Özgül</a></label><ul class="navContent" id="hoverEnabled"><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li><li><a href="/projects">Projects</a></li><li><a href="/blogs" class="active">Blog</a></li></ul></div></nav></header><div class="wrapper"><h2 class="post-title">Any Codable</h2><a><p>February 1, 2023<br/>Reading 24 minutes</p></a><ul class="tag-list"><li class="swift"><a href="/tags/swift">Swift</a></li><li class="codable"><a href="/tags/codable">Codable</a></li><li class="other"><a href="/tags/json">Json</a></li><li class="other"><a href="/tags/decode">Decode</a></li><li class="other"><a href="/tags/encode">Encode</a></li></ul><div class="post-description"><div><p>Swift codable kolayca data-model arasında decode veya encode işlemi yapmamızı sağlıyor. Peki elimizdeki generic şekilde decode veya encode nasıl yapabiliriz.</p><p>İlk olarak neden böyle bir şeye ihtiyacımız olsun ki sorusunu cevaplayalım, geliştirdiğim bir request mocking uygulaması tek bir dosya içine json formatında request body, response body, header gibi verileri formatlı şekilde saklama isteğim ile başta string olarak dosyaya ekledim ancak string olarak saklamak hem okuması zor hem de bu veriyi gösterirken sürekli ekstra encode decode yapmak gerekiyordu. Çözüm olarak Any tipini encode ve decode işlemi yapmam gerekti.</p><p>Swiftte Any tüm tipleri kapsayan bir tiptir, kullanabildiğimiz bütün tipler aslında Any’dir. Ancak Any encodable veya codable desteklemez. Ancak encode ve decode methodlarını kendimiz yazarak destek sağlayabiliriz. Temelde Any üzerinden decode veya encode yapacağız ama bu işlem sırasında Any tipini codable bir tip’e cast edip yapmalıyız.</p><h3>Decode</h3><p>Decode işlemi data tipini alıp elimizdeki bir modele çevirebiliriz, datayı tek tek okuyup tipini belirleyip decode işlemi yapabiliriz. Json root olarak iki tipte olabilir, Array veya key value şeklinde dictionary.</p><ol><li>İlk olarak gelen datanın Dictionary ya da Array olduduğunu belirlemek gerekir</li></ol><pre><code><span class="keyword">func</span> decode(<span class="keyword">_</span> type: <span class="type">Any</span>.<span class="type">Type</span>, forKey key: <span class="type">K</span>) <span class="keyword">throws</span> -&gt; <span class="type">Any</span> {
        <span class="keyword">if let</span> container = <span class="keyword">try</span>? <span class="keyword">self</span>.<span class="call">nestedContainer</span>(keyedBy: <span class="type">JSONCodingKeys</span>.<span class="keyword">self</span>, forKey: key),
           <span class="keyword">let</span> value = <span class="keyword">try</span>? container.<span class="call">decode</span>([<span class="type">String</span>: <span class="type">Any</span>].<span class="keyword">self</span>) {
            <span class="keyword">return</span> value
        } <span class="keyword">else if var</span> container = <span class="keyword">try</span>? <span class="keyword">self</span>.<span class="call">nestedUnkeyedContainer</span>(forKey: key),
                  <span class="keyword">let</span> value = <span class="keyword">try</span>? container.<span class="call">decode</span>([<span class="type">Any</span>].<span class="keyword">self</span>) {
            <span class="keyword">return</span> value
        } <span class="keyword">else</span> {
            <span class="keyword">throw</span> <span class="type">EncodingError</span>.<span class="call">invalidValue</span>(key, .<span class="keyword">init</span>(codingPath: codingPath, debugDescription: <span class="string">"Invalid JSON value"</span>))
        }
    }
</code></pre><ol start="2"><li>Dictionary datayı decode etmek, for loop yardımıyla if let ile tipi belirleyip decode işlemi yapılıyor</li></ol><pre><code><span class="keyword">func</span> decode(<span class="keyword">_</span> type: [<span class="type">String</span>: <span class="type">Any</span>].<span class="type">Type</span>) <span class="keyword">throws</span> -&gt; [<span class="type">String</span>: <span class="type">Any</span>] {
        <span class="keyword">var</span> dictionary = [<span class="type">String</span>: <span class="type">Any</span>]()

        <span class="keyword">for</span> key <span class="keyword">in</span> allKeys {
            <span class="keyword">if let</span> boolValue = <span class="keyword">try</span>? <span class="call">decode</span>(<span class="type">Bool</span>.<span class="keyword">self</span>, forKey: key) {
                dictionary[key.<span class="property">stringValue</span>] = boolValue
            } <span class="keyword">else if let</span> stringValue = <span class="keyword">try</span>? <span class="call">decode</span>(<span class="type">String</span>.<span class="keyword">self</span>, forKey: key) {
                dictionary[key.<span class="property">stringValue</span>] = stringValue
            } <span class="keyword">else if let</span> intValue = <span class="keyword">try</span>? <span class="call">decode</span>(<span class="type">Int</span>.<span class="keyword">self</span>, forKey: key) {
                dictionary[key.<span class="property">stringValue</span>] = intValue
            } <span class="keyword">else if let</span> doubleValue = <span class="keyword">try</span>? <span class="call">decode</span>(<span class="type">Double</span>.<span class="keyword">self</span>, forKey: key) {
                dictionary[key.<span class="property">stringValue</span>] = doubleValue
            } <span class="keyword">else if let</span> nestedDictionary = <span class="keyword">try</span>? <span class="call">decode</span>([<span class="type">String</span>: <span class="type">Any</span>].<span class="keyword">self</span>, forKey: key) {
                dictionary[key.<span class="property">stringValue</span>] = nestedDictionary
            } <span class="keyword">else if let</span> nestedArray = <span class="keyword">try</span>? <span class="call">decode</span>([<span class="type">Any</span>].<span class="keyword">self</span>, forKey: key) {
                dictionary[key.<span class="property">stringValue</span>] = nestedArray
            } <span class="keyword">else</span> {
                <span class="keyword">do</span> {
                    <span class="keyword">if try</span> <span class="call">decode</span>(<span class="type">String</span>?.<span class="keyword">self</span>, forKey: key) == <span class="keyword">nil</span> {
                        dictionary[key.<span class="property">stringValue</span>] = <span class="keyword">nil</span>
                    }
                } <span class="keyword">catch</span> { }
            }
        }
        <span class="keyword">return</span> dictionary
    }
</code></pre><ol start="3"><li>Array decode etmek ise Dictionary ile oldukça yakın, for loop ile listeyi dönüp tipini belirleyip decode etmek yeterli</li></ol><pre><code><span class="keyword">func</span> decode(<span class="keyword">_</span> type: [<span class="type">Any</span>].<span class="type">Type</span>) <span class="keyword">throws</span> -&gt; <span class="type">Any</span> {
        <span class="keyword">var</span> array = [<span class="type">Any</span>?]()

        <span class="keyword">for</span> key <span class="keyword">in</span> allKeys {
            <span class="keyword">if let</span> boolValue = <span class="keyword">try</span>? <span class="call">decode</span>(<span class="type">Bool</span>.<span class="keyword">self</span>, forKey: key) {
                array.<span class="call">append</span>(boolValue)
            } <span class="keyword">else if let</span> stringValue = <span class="keyword">try</span>? <span class="call">decode</span>(<span class="type">String</span>.<span class="keyword">self</span>, forKey: key) {
                array.<span class="call">append</span>(stringValue)
            } <span class="keyword">else if let</span> intValue = <span class="keyword">try</span>? <span class="call">decode</span>(<span class="type">Int</span>.<span class="keyword">self</span>, forKey: key) {
                array.<span class="call">append</span>(intValue)
            } <span class="keyword">else if let</span> doubleValue = <span class="keyword">try</span>? <span class="call">decode</span>(<span class="type">Double</span>.<span class="keyword">self</span>, forKey: key) {
                array.<span class="call">append</span>(doubleValue)
            } <span class="keyword">else if let</span> nestedDictionary = <span class="keyword">try</span>? <span class="call">decode</span>([<span class="type">String</span>: <span class="type">Any</span>].<span class="keyword">self</span>, forKey: key) {
                array.<span class="call">append</span>(nestedDictionary)
            } <span class="keyword">else if let</span> nestedArray = <span class="keyword">try</span>? <span class="call">decode</span>([<span class="type">Any</span>].<span class="keyword">self</span>, forKey: key) {
                array.<span class="call">append</span>(nestedArray)
            } <span class="keyword">else</span> {
                <span class="keyword">do</span> {
                    <span class="keyword">if try</span> <span class="call">decode</span>(<span class="type">String</span>?.<span class="keyword">self</span>, forKey: key) == <span class="keyword">nil</span> {
                        array.<span class="call">append</span>(<span class="keyword">nil</span>)
                    }
                } <span class="keyword">catch</span> { }
            }
        }
        <span class="keyword">return</span> array
    }
</code></pre><h3>Encoding</h3><p>Encode işlemi decode işleminin tam tersidir, ancak mantık olarak oldukça yakın, tipi belirle encode et</p><ol><li>Root tipi belirlemek</li></ol><pre><code><span class="keyword">mutating func</span> encode(<span class="keyword">_</span> value: <span class="type">Any</span>, forKey key: <span class="type">Key</span>) <span class="keyword">throws</span> {
        <span class="keyword">if let</span> jsonValue = value <span class="keyword">as</span>? [<span class="type">Any</span>] {
            <span class="keyword">var</span> unkeyedContainer = <span class="keyword">self</span>.<span class="call">nestedUnkeyedContainer</span>(forKey: key)
            <span class="keyword">try</span> unkeyedContainer.<span class="call">encode</span>(jsonValue)
        } <span class="keyword">else if let</span> jsonValue = value <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">Any</span>] {
            <span class="keyword">var</span> keyedContainer = <span class="keyword">self</span>.<span class="call">nestedContainer</span>(keyedBy: <span class="type">JSONCodingKeys</span>.<span class="keyword">self</span>, forKey: key)
            <span class="keyword">try</span> keyedContainer.<span class="call">encode</span>(jsonValue)
        } <span class="keyword">else if let</span> jsonValue = value <span class="keyword">as</span>? <span class="type">EmptyResponse</span> {
            <span class="keyword">var</span> unkeyedContainer = <span class="keyword">self</span>.<span class="call">nestedUnkeyedContainer</span>(forKey: key)
            <span class="keyword">try</span> unkeyedContainer.<span class="call">encode</span>(jsonValue)
        } <span class="keyword">else</span> {
            <span class="keyword">throw</span> <span class="type">EncodingError</span>.<span class="call">invalidValue</span>(key, .<span class="keyword">init</span>(codingPath: codingPath, debugDescription: <span class="string">"Invalid JSON value"</span>))
        }
    }
</code></pre><ol start="2"><li>Dictionary tipi encode etmek, for loop yardımıyla key value şeklinde dönüp tipi belirleyip encode edebiliriz</li></ol><pre><code><span class="keyword">mutating func</span> encode(<span class="keyword">_</span> value: [<span class="type">String</span>: <span class="type">Any</span>]) <span class="keyword">throws</span> {
        <span class="keyword">try</span> value.<span class="call">forEach</span>({ (key, jsonValue) <span class="keyword">in
            let</span> key = <span class="type">JSONCodingKeys</span>(stringValue: key)
            <span class="keyword">switch</span> jsonValue {
            <span class="keyword">case let</span> value <span class="keyword">as</span> <span class="type">Bool</span> <span class="keyword">where</span> (<span class="call">type</span>(of: jsonValue) == <span class="call">type</span>(of: <span class="type">NSNumber</span>(booleanLiteral: <span class="keyword">true</span>)) || <span class="call">type</span>(of: jsonValue) == <span class="type">Swift</span>.<span class="type">Bool</span>.<span class="keyword">self</span>):
                <span class="keyword">try</span> <span class="call">encode</span>(value, forKey: key)
            <span class="keyword">case let</span> value <span class="keyword">as</span> <span class="type">Int</span>:
                <span class="keyword">try</span> <span class="call">encode</span>(value, forKey: key)
            <span class="keyword">case let</span> value <span class="keyword">as</span> <span class="type">String</span>:
                <span class="keyword">try</span> <span class="call">encode</span>(value, forKey: key)
            <span class="keyword">case let</span> value <span class="keyword">as</span> <span class="type">Double</span>:
                <span class="keyword">try</span> <span class="call">encode</span>(value, forKey: key)
            <span class="keyword">case let</span> value <span class="keyword">as</span> <span class="type">CGFloat</span>:
                <span class="keyword">try</span> <span class="call">encode</span>(value, forKey: key)
            <span class="keyword">case let</span> value <span class="keyword">as</span> [<span class="type">String</span>: <span class="type">Any</span>]:
                <span class="keyword">try</span> <span class="call">encode</span>(value, forKey: key)
            <span class="keyword">case let</span> value <span class="keyword">as</span> [<span class="type">Any</span>]:
                <span class="keyword">try</span> <span class="call">encode</span>(value, forKey: key)
            <span class="keyword">case</span> <span class="type">Optional</span>&lt;<span class="type">Any</span>&gt;.<span class="property">none</span>, is <span class="type">NSNull</span>:
                <span class="keyword">try</span> <span class="call">encodeNil</span>(forKey: key)
            <span class="keyword">default</span>:
                <span class="keyword">throw</span> <span class="type">EncodingError</span>.<span class="call">invalidValue</span>(value, .<span class="keyword">init</span>(codingPath: codingPath, debugDescription: <span class="string">"Invalid JSON value"</span>))
            }
        })
    }
</code></pre><ol start="3"><li>Array tipi ise yine aynı şekilde for loop ile dönüp tipi belirleyip encode edebiliriz</li></ol><pre><code><span class="keyword">mutating func</span> encode(<span class="keyword">_</span> value: [<span class="type">Any</span>]) <span class="keyword">throws</span> {
        <span class="keyword">try</span> value.<span class="call">enumerated</span>().<span class="call">forEach</span>({ (index, jsonValue) <span class="keyword">in
            switch</span> jsonValue {
            <span class="keyword">case let</span> value <span class="keyword">as</span> <span class="type">Bool</span> <span class="keyword">where</span> (<span class="call">type</span>(of: jsonValue) == <span class="call">type</span>(of: <span class="type">NSNumber</span>(booleanLiteral: <span class="keyword">true</span>)) || <span class="call">type</span>(of: jsonValue) == <span class="type">Swift</span>.<span class="type">Bool</span>.<span class="keyword">self</span>):
                <span class="keyword">try</span> <span class="call">encode</span>(value)
            <span class="keyword">case let</span> value <span class="keyword">as</span> <span class="type">Int</span>:
                <span class="keyword">try</span> <span class="call">encode</span>(value)
            <span class="keyword">case let</span> value <span class="keyword">as</span> <span class="type">String</span>:
                <span class="keyword">try</span> <span class="call">encode</span>(value)
            <span class="keyword">case let</span> value <span class="keyword">as</span> <span class="type">Double</span>:
                <span class="keyword">try</span> <span class="call">encode</span>(value)
            <span class="keyword">case let</span> value <span class="keyword">as</span> <span class="type">CGFloat</span>:
                <span class="keyword">try</span> <span class="call">encode</span>(value)
            <span class="keyword">case let</span> value <span class="keyword">as</span> [<span class="type">String</span>: <span class="type">Any</span>]:
                <span class="keyword">try</span> <span class="call">encode</span>(value)
            <span class="keyword">case let</span> value <span class="keyword">as</span> [<span class="type">Any</span>]:
                <span class="keyword">var</span> unkeyedContainer = <span class="keyword">self</span>.<span class="call">nestedUnkeyedContainer</span>()
                <span class="keyword">try</span> unkeyedContainer.<span class="call">encode</span>(value)
            <span class="keyword">case</span> <span class="type">Optional</span>&lt;<span class="type">Any</span>&gt;.<span class="property">none</span>, is <span class="type">NSNull</span>:
                <span class="keyword">try</span> <span class="call">encodeNil</span>()
            <span class="keyword">default</span>:
                <span class="keyword">let</span> keys = <span class="type">JSONCodingKeys</span>(intValue: index).<span class="call">map</span>({ [ $0 ] }) ?? []
                <span class="keyword">throw</span> <span class="type">EncodingError</span>.<span class="call">invalidValue</span>(value, <span class="type">EncodingError</span>.<span class="type">Context</span>(codingPath: codingPath + keys, debugDescription: <span class="string">"Invalid JSON value"</span>))
            }
        })
    }
</code></pre><p>Elbette bu kod parçaları doğrudan Any tipini decode veya encode etmeye yeterli değil. Tamamını bir swift package şeklinde Github hesabım üzerinden yayınladım. Dilerseniz basit dependency’i projenize ekleyip kullanabilirsiniz. Link: <a href="https://github.com/yusufozgul/AnyCodable">https://github.com/yusufozgul/AnyCodable</a>. Okuduğunuz için teşekkür ederim, sonraki yazıda görüşmek dileğiyle.</p></div></div></div><footer><p><a href="https://github.com/johnsundell/publish">Generated using Publish</a></p><p><a href="/feed.rss">RSS feed</a></p><p><a href="https://github.com/yusufozgul">Developed Yusuf Özgül</a></p></footer></body></html>