<!DOCTYPE html><html lang="tr"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Yusuf Özgül | Blog | Resume | Portfolio"/><link rel="canonical" href="https://yusufozgul.com/blogs/asyncOperationInMainThread"/><meta name="twitter:url" content="https://yusufozgul.com/blogs/asyncOperationInMainThread"/><meta name="og:url" content="https://yusufozgul.com/blogs/asyncOperationInMainThread"/><title>Async operation in Main Thread | Yusuf Özgül | Blog | Resume | Portfolio</title><meta name="twitter:title" content="Async operation in Main Thread | Yusuf Özgül | Blog | Resume | Portfolio"/><meta name="og:title" content="Async operation in Main Thread | Yusuf Özgül | Blog | Resume | Portfolio"/><meta name="description" content="What, why would we need async operation in main thread. Generally yes we wouldn't need. But sometimes we need, this blog about async operation in main thread."/><meta name="twitter:description" content="What, why would we need async operation in main thread. Generally yes we wouldn't need. But sometimes we need, this blog about async operation in main thread."/><meta name="og:description" content="What, why would we need async operation in main thread. Generally yes we wouldn't need. But sometimes we need, this blog about async operation in main thread."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><link rel="stylesheet" href="/gallery.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/upload-images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Yusuf Özgül | Blog | Resume | Portfolio"/><meta name="twitter:image" content="https://yusufozgul.com/upload-images/"/><meta name="og:image" content="https://yusufozgul.com/upload-images/"/></head><body class="main-wrapper"><header><link rel="stylesheet" href="/navigationStyle.css" type="text/css"/><nav class="header navBar"><div class="navArea"><input type="checkbox" id="check"/><label for="check"><img src="/upload-images/base/menu-icon.svg" width="30" height="30" class="checkbtn"/></label><label class="logo"><a href="/">Yusuf Özgül</a></label><ul class="navContent" id="hoverEnabled"><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li><li><a href="/projects">Projects</a></li><li><a href="/blogs" class="active">Blog</a></li></ul></div></nav></header><div class="wrapper"><h2 class="post-title">Async operation in Main Thread</h2><a><p>April 17, 2022<br/>Reading 6 minutes</p></a><ul class="tag-list"><li class="swift"><a href="/tags/swift">Swift</a></li><li class="other"><a href="/tags/async">Async</a></li><li class="other"><a href="/tags/await">Await</a></li><li class="other"><a href="/tags/webview">WebView</a></li></ul><div class="post-description"><div><p>What, why would we need async operation in main thread. Generally yes we wouldn't need. But sometimes we need, this blog about async operation in main thread.</p><p>Async - await introduced in Swift 5.5 also supports iOS 13 and above. Async - await is simple than closures.</p><p>This is simple async await code:</p><pre><code><span class="keyword">func</span> fetchMovie() <span class="keyword">async throws</span> -&gt; <span class="type">MovieResponse</span> {
    <span class="keyword">let</span> (data, response) = <span class="keyword">try await</span> <span class="type">URLSession</span>.<span class="property">shared</span>.<span class="call">data</span>(from: url)
        <span class="keyword">return try</span> decoder.<span class="call">decode</span>(<span class="type">MovieResponse</span>.<span class="keyword">self</span>, from: data)
}
</code></pre><p>In this case we don't need main thread while requesting. Ok, when would we need? Have you ever use Webview and connect your swift code and webview. You must use <code>evaluateJavaScript</code> . This method return result inside closure.</p><pre><code>webView.<span class="call">evaluateJavaScript</span>(<span class="string">"document.getElementById('someElement').innerText"</span>) { (result, error) <span class="keyword">in
    if let</span> error = error {
        <span class="call">print</span>(error)
    }
}
</code></pre><p>Also, it has a new async method. But there is a problem, <code>evaluateJavaScript</code> must run in main thread. How we use <code>evaluateJavaScript</code> in main thread.</p><p>We can use <code>withUnsafeThrowingContinuation</code>. This method gives a closure and waits until we call it. We can run our code in main thread.</p><pre><code><span class="keyword">extension</span> <span class="type">WKWebView</span> {
    <span class="keyword">@discardableResult
    func</span> runJavaScript(<span class="keyword">_</span> javaScript: <span class="type">String</span>) <span class="keyword">async throws</span> -&gt; <span class="type">Any</span>? {
        <span class="keyword">try await</span> <span class="call">withUnsafeThrowingContinuation</span>({ continuation <span class="keyword">in</span>
            <span class="type">DispatchQueue</span>.<span class="property">main</span>.<span class="call">async</span> {
                <span class="keyword">self</span>.<span class="call">evaluateJavaScript</span>(javaScript) { result, error <span class="keyword">in
                    if let</span> error = error {
                        continuation.<span class="call">resume</span>(throwing: error)
                    } <span class="keyword">else</span> {
                        continuation.<span class="call">resume</span>(with: .<span class="call">success</span>(result))
                    }
                }
            }
        })
    }
}
</code></pre><p>Note: Until <code>withUnsafeThrowingContinuation</code> finishes, main thread is blocked. So our UI will be freeze and not respond. You should use it carefully.</p><p>Thanks for reading, if you are interested you can read my other blogs.</p></div></div></div><footer><p><a href="https://github.com/johnsundell/publish">Generated using Publish</a></p><p><a href="/feed.rss">RSS feed</a></p><p><a href="https://github.com/yusufozgul">Developed Yusuf Özgül</a></p></footer></body></html>